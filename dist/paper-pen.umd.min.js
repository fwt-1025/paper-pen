!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).PaperPen={})}(this,(function(t){"use strict";function e(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,i)}return r}function r(t){for(var r=1;r<arguments.length;r++){var i=null!=arguments[r]?arguments[r]:{};r%2?e(Object(i),!0).forEach((function(e){s(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):e(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,p(i.key),i)}}function o(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function s(t,e,r){return(e=p(e))in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&l(t,e)}function h(t){return h=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},h(t)}function l(t,e){return l=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},l(t,e)}function c(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function u(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,i=h(t);if(e){var n=h(this).constructor;r=Reflect.construct(i,arguments,n)}else r=i.apply(this,arguments);return function(t,e){if(e&&("object"==typeof e||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return c(t)}(this,r)}}function f(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var r=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=r){var i,n,o,s,a=[],h=!0,l=!1;try{if(o=(r=r.call(t)).next,0===e){if(Object(r)!==r)return;h=!1}else for(;!(h=(i=o.call(r)).done)&&(a.push(i.value),a.length!==e);h=!0);}catch(t){l=!0,n=t}finally{try{if(!h&&null!=r.return&&(s=r.return(),Object(s)!==s))return}finally{if(l)throw n}}return a}}(t,e)||d(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function v(t){return function(t){if(Array.isArray(t))return y(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||d(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function d(t,e){if(t){if("string"==typeof t)return y(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?y(t,e):void 0}}function y(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,i=new Array(e);r<e;r++)i[r]=t[r];return i}function p(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var i=r.call(t,e||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}var g=function(){function t(){i(this,t),this.eventList={}}return o(t,[{key:"on",value:function(t,e){this.eventList[t]=this.eventList[t]||[],this.eventList[t].push(e)}},{key:"emit",value:function(t){for(var e=this,r=arguments.length,i=new Array(r>1?r-1:0),n=1;n<r;n++)i[n-1]=arguments[n];this.eventList[t]&&this.eventList[t].forEach((function(t){t.call.apply(t,[e].concat(i))}))}},{key:"off",value:function(t,e){this.eventList[t]=this.eventList[t].filter((function(t){return t!==e}))}}]),t}(),m=function(){function t(e,r,n,o,s,a){i(this,t),this.a=e||1,this.b=r||0,this.c=n||0,this.d=o||1,this.e=s||0,this.f=a||0}return o(t,[{key:"translate",value:function(t,e){return this.transform(1,0,0,1,t,e)}},{key:"scaleU",value:function(t){return this.transform(t,0,0,t,0,0)}},{key:"scale",value:function(t,e){return this.transform(t,0,0,e,0,0)}},{key:"rotate",value:function(t){var e=Math.cos(t),r=Math.sin(t);return this.transform(e,r,-r,e,0,0)}},{key:"rotateAngle",value:function(t){var e=t/180*Math.PI;return this.rotate(e)}},{key:"transform",value:function(t,e,r,i,n,o){var s=this,a=this.a,h=this.b,l=this.c,c=this.d,u=this.e,f=this.f;return s.a=a*t+l*e,s.b=h*t+c*e,s.c=a*r+l*i,s.d=h*r+c*i,s.e=a*n+l*o+u,s.f=h*n+c*o+f,s}},{key:"applyToPoint",value:function(t,e){var r=this;return{x:t*r.a+e*r.c+r.e,y:t*r.b+e*r.d+r.f}}},{key:"clone",value:function(){return new t(this.a,this.b,this.c,this.d,this.e,this.f)}}]),t}(),x={scaleX:1,scaleY:1,angle:0,skewX:0,skewY:0,translateX:0,translateY:0,width:0,height:0,left:0,top:0,originX:"left",originY:"top"},b=function(t){a(r,t);var e=u(r);function r(t,n){var o;return i(this,r),s(c(o=e.call(this)),"el",null),s(c(o),"width",0),s(c(o),"height",0),s(c(o),"lowerCanvas",null),s(c(o),"lowerContext",null),s(c(o),"upperCanvas",null),s(c(o),"canvasContainer",null),s(c(o),"transform",[1,0,0,1,0,0]),s(c(o),"transformMatrix",new m),s(c(o),"defaultTransform",x),s(c(o),"_objects",[]),s(c(o),"_activeObject",null),s(c(o),"selection",!0),s(c(o),"selectionLineWidth",1),s(c(o),"selectionColor","#00f"),s(c(o),"selectionBorderColor","#000"),s(c(o),"selectionOpacity",.3),s(c(o),"background",""),s(c(o),"backgroundImage",new Image),s(c(o),"baseWidth",!1),s(c(o),"baseHeight",!0),s(c(o),"ratio",{x:1,y:1}),s(c(o),"pixelSize",{w:0,h:0}),o.setOptions(n),o.el=t,o.initLowerCanvas(),o.initCanvasContainer(),o.initUpperCanvas(),o}return o(r,[{key:"setOptions",value:function(t){for(var e in t)this[e]=t[e]}},{key:"initLowerCanvas",value:function(){if(!this.el)throw new Error("Canvas must have an 'el' parameter and cannot be empty");"string"==typeof this.el?this.lowerCanvas=document.querySelector(this.el):this.lowerCanvas=this.el,this.setCanvasStyles(this.lowerCanvas),this.lowerCanvas.classList.add("lower-canvas"),this.lowerContext=this.lowerCanvas.getContext("2d")}},{key:"initCanvasContainer",value:function(){var t;this.canvasContainer=document.createElement("div"),this.canvasContainer.classList.add("canvas-container"),null===(t=this.lowerCanvas)||void 0===t||null===(t=t.parentNode)||void 0===t||t.replaceChild(this.canvasContainer,this.lowerCanvas),this.canvasContainer.appendChild(this.lowerCanvas),this.canvasContainer.style.position="relative",this.canvasContainer.style.width=this.width+"px",this.canvasContainer.style.height=this.height+"px"}},{key:"initUpperCanvas",value:function(){var t;this.upperCanvas=document.createElement("canvas"),this.upperCanvas.classList.add("upper-canvas"),this.upperContext=this.upperCanvas.getContext("2d"),this.setCanvasStyles(this.upperCanvas),null===(t=this.canvasContainer)||void 0===t||t.appendChild(this.upperCanvas)}},{key:"setCanvasStyles",value:function(t){var e={position:"absolute",top:"0px",left:"0px",width:this.width+"px",height:this.height+"px"};Object.entries(e).forEach((function(e){var r=f(e,2),i=r[0],n=r[1];t.style.setProperty(i,n)})),t.width=this.width,t.height=this.height}},{key:"add",value:function(){for(var t,e=this,r=arguments.length,i=new Array(r),n=0;n<r;n++)i[n]=arguments[n];i.forEach((function(t){t.setCoords&&t.setCoords(e.lowerContext,e)})),(t=this._objects).push.apply(t,i),this.emit("obj:add"),this.requestRenderAll()}},{key:"remove",value:function(t){this._objects=this._objects.filter((function(e){return e.id!==t.id})),this.emit("obj:remove")}},{key:"requestRenderAll",value:function(){window.requestAnimationFrame(this._renderAll.bind(this))}},{key:"_renderAll",value:function(){var t=this;this.lowerContext.setTransform(this.transformMatrix.clone()),this.clearContext(this.lowerContext),this.backgroundImage&&this.drawBackground(this.lowerContext),this.emit("render:before"),this.lowerContext.save(),this._objects.forEach((function(e){e.render(t.lowerContext,t)})),this.lowerContext.restore(),this.emit("render:after")}},{key:"setBackground",value:function(t,e){var r=this;if("string"==typeof t)return this.backgroundImage.src=t,void(this.backgroundImage.onload=function(){r.pixelSize={w:r.backgroundImage.naturalWidth,h:r.backgroundImage.naturalHeight};var t=r.backgroundImage.naturalWidth/r.backgroundImage.naturalHeight;r.baseWidth?(r.width=r.width,r.height=r.width/t):r.baseHeight&&(r.width=r.height*t,r.height=r.height),null!=e&&e.width&&null!=e&&e.height&&(r.width=e.width,r.height=e.height),r.setCanvasStyles(r.lowerCanvas),r.setCanvasStyles(r.upperCanvas),r.emit("img:load",r),r.requestRenderAll()});this.backgroundImage=t,this.requestRenderAll()}},{key:"drawBackground",value:function(t){t.save(),t.drawImage(this.backgroundImage,0,0,this.width,this.height),t.restore()}},{key:"clearContext",value:function(t){t.save(),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,this.width,this.height),t.restore()}},{key:"renderTop",value:function(){var t=this.upperContext;this.clearContext(t),this.renderTopLayer(t)}},{key:"renderTopLayer",value:function(t){t.save(),t.globalAlpha=this.selectionOpacity,this.selection&&this._groupSelector&&(this._drawSelection(t),this.contextTopDirty=!0),t.restore()}},{key:"_drawSelection",value:function(t){var e=this._groupSelector,r=e.x,i=e.y,n=e.deltaX,o=e.deltaY,s=this.transformMatrix,a=s.a;s.b,s.c,s.d,r=r*a+s.e,i=i*a+s.f,this.selectionColor&&(t.fillStyle=this.selectionColor,t.fillRect(r,i,n*a,o*a)),this.selectionLineWidth&&this.selectionBorderColor&&(t.lineWidth=this.selectionLineWidth,t.strokeStyle=this.selectionBorderColor,t.strokeRect(r,i,n*a,o*a))}},{key:"setDefaultTransform",value:function(t,e){this.defaultTransform={target:e,scaleX:e.scaleX,scaleY:e.scaleY,originX:e.originX,originY:e.originY,width:e.width*e.scaleX,offsetX:t.x-e.left,offsetY:t.y-e.top,left:e.left,top:e.top,height:e.height*e.scaleY,angle:e.angle}}},{key:"set",value:function(t,e){this[t]=e}},{key:"_findTarget",value:function(t,e){for(var r=this,i=t,n=e.map((function(t){return t.getCoords(r.lowerContext)})),o=(n=e[0].target.rotate?n.slice(0,7):n).map((function(t,e){return[t,n[(e+1)%n.length]]})),s=i.x,a=i.y,h=!1,l=0,c=o.length;l<c;l++){var u=o[l][0].x,f=o[l][0].y,v=o[l][1].x,d=o[l][1].y;if(u===s&&f===a||v===s&&d===a)return!0;if(f===d&&f===a&&(u>s&&v<s||u<s&&v>s))return!0;if(f<a&&d>=a||f>=a&&d<a){var y=u+(a-f)*(v-u)/(d-f);if(y===s)return!0;y>s&&(h=!h)}}return!!h}},{key:"setActiveObject",value:function(t){t?this._activeObject=t:(this._activeObject&&this._activeObject.set("isActive",!1),this._activeObject=null)}},{key:"getActiveObject",value:function(){return this._activeObject}},{key:"setCursorFromTarget",value:function(t){this.setCursor("pointer")}},{key:"setCursor",value:function(t){this.upperCanvas.style.cursor=t}},{key:"resetActive",value:function(){this._objects.forEach((function(t){t.set("isActive",!1)}))}},{key:"destroy",value:function(){}},{key:"toObjects",value:function(){return{objects:this._objects,pixelSize:this.pixelSize}}}]),r}(g),w={startPos:null};function C(t,e,r,i){var n=r.width,o=r.height,s=r.left,a=r.top,h=r.originX,l=r.originY,c=r.angle,u=i.x,f=i.y,v=JSON.parse(JSON.stringify(e));return{width:n,height:o,left:s,top:a,originX:h,originY:l,angle:c,msPos:{x:(u-h)*Math.cos(-c)-(f-l)*Math.sin(-c)+h,y:(u-h)*Math.sin(-c)+(f-l)*Math.cos(-c)+l},pointer:e={x:(e.x-h)*Math.cos(-c)-(e.y-l)*Math.sin(-c)+h,y:(e.x-h)*Math.sin(-c)+(e.y-l)*Math.cos(-c)+l},cachePos:v}}var k=function(t,e,r,i,n){t.left=r.x,t.top=r.y,e.points[t.index]=t.getCoords()},M=function(t,e,r){e.points.splice(t.index+1,0,t.getCoords())},P=function(t,e,r,i,n){e.lockMove||(w.startPos||(w.startPos=n),null!=e&&e.left&&null!=e&&e.top?(e.originX+=r.x-w.startPos.x,e.originY+=r.y-w.startPos.y):e.points.forEach((function(t){t.x+=r.x-w.startPos.x,t.y+=r.y-w.startPos.y})),w.startPos=r)},S=function(t,e,r){t.addEventListener(e,r)},O=function(t){for(var e=arguments.length,r=new Array(e>1?e-1:0),i=1;i<e;i++)r[i-1]=arguments[i];return t.removeEventListener.apply(t,r)},T=function(t){a(r,t);var e=u(r);function r(t,n){var o;return i(this,r),s(c(o=e.call(this,t,n||{})),"targetCornerIndex",-1),s(c(o),"mousedownPos",{x:0,y:0}),s(c(o),"corner",null),s(c(o),"preventDefault",!0),s(c(o),"_groupSelector",null),s(c(o),"selection",!0),s(c(o),"skipFindTarget",!1),o.initBindEvents(),o.initEvents(),o}return o(r,[{key:"initBindEvents",value:function(){var t=this;["handleMouseDown","handleMouseMove","handleMouseUp","handleMouseWheel"].forEach((function(e){t[e]=t[e].bind(t)}))}},{key:"initEvents",value:function(){this.upperCanvas instanceof HTMLElement&&(S(this.upperCanvas,"mousedown",this.handleMouseDown),S(this.upperCanvas,"mousemove",this.handleMouseMove),S(this.upperCanvas,"mouseup",this.handleMouseUp),S(this.upperCanvas,"mousewheel",this.handleMouseWheel),this.preventDefault&&S(this.upperCanvas,"contextmenu",(function(t){t.preventDefault()})))}},{key:"handleMouseDown",value:function(t){var e=this.getMousePosInfo(t);if(2!==t.button){var r=this.getPointer(e);this.mousedownPos=r;var i=this.getActiveObject();if(this.corner&&i&&!this.skipFindTarget)return this.corner.isEditing=!0,this.setDefaultTransform(r,i),this.corner.mousedownHandler&&this.corner.mousedownHandler(this.corner,this.corner.target,this.mousedownPos),void this.requestRenderAll();if(!this.corner&&!this.skipFindTarget){var n=this.findTarget(r);n&&n!==i&&(i&&i.set("isActive",!1),this.setActiveObject(n),n.set("isActive",!0)),n||this.setActiveObject(null),this.requestRenderAll()}this.emit("mouse:down",e),this._activeObject&&!this.skipFindTarget&&(this.objectMoving=!0),this.selection&&!this.getActiveObject()&&(this._groupSelector={x:r.x,y:r.y,deltaX:0,deltaY:0}),S(this.upperCanvas,"mousemove",this.handleMouseMove),this.requestRenderAll()}else this.emit("mouse:down",e)}},{key:"handleMouseMove",value:function(t){var e,r=this.getMousePosInfo(t),i=this.getPointer(r);if(this._activeObject&&!this.skipFindTarget&&(null==this||null===(e=this.corner)||void 0===e||!e.isEditing)){for(var n,o=0;o<this._activeObject.coords.length;o++){var s=this._activeObject.coords[o];if(s.isPointInControl(this.getPointer(t),this.transformMatrix)){this.corner=s;var a=this.corner.cursorHandler&&this.corner.cursorHandler(this._activeObject,this.corner);this.setCursor(a||s.cursor);break}this.setCursor("default"),this.corner=null}if(null!==(n=this._activeObject.centerControlCoords)&&void 0!==n&&n.length&&!this.corner)for(var h=0;h<this._activeObject.centerControlCoords.length;h++){var l=this._activeObject.centerControlCoords[h];if(l.isPointInControl(this.getPointer(t),this.transformMatrix)){this.corner=l,this.setCursor(l.cursor);break}this.setCursor("default"),this.corner=null}}this.corner&&this.corner.isEditing&&!this.skipFindTarget&&(this.corner.mousemoveHandler&&this.corner.mousemoveHandler(this.corner,this.corner.target,i,this.defaultTransform,this.mousedownPos),this.requestRenderAll()),this.objectMoving&&this._activeObject&&(P(this.corner,this._activeObject,i,this.defaultTransform,this.mousedownPos),this.requestRenderAll());var c=this._groupSelector;if(c&&(c.deltaX=i.x-c.x,c.deltaY=i.y-c.y,this.renderTop()),!this.corner){var u=this.findTarget(i);u?(this.setCursor("move"),r.target=u):this.setCursor("default")}this.emit("mouse:move",r)}},{key:"handleMouseUp",value:function(t){var e=this.getMousePosInfo(t);this.emit("mouse:up",e),this.objectMoving=!1,w.startPos=null,this._groupSelector=null,2!==t.button&&(this.corner=null,this.contextTopDirty&&this.clearContext(this.upperContext))}},{key:"handleMouseWheel",value:function(t){var e=this.getMousePosInfo(t);this.emit("mouse:wheel",e)}},{key:"getMousePosInfo",value:function(t){return{clientX:t.clientX,clientY:t.clientY,type:t.type,button:t.button,offsetX:t.offsetX,offsetY:t.offsetY,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,deltaY:t.deltaY}}},{key:"getPointer",value:function(t){var e,r=null===(e=this.upperCanvas)||void 0===e?void 0:e.getBoundingClientRect();return{x:(t.clientX-r.left-this.transformMatrix.e)/this.transformMatrix.a,y:(t.clientY-r.top-this.transformMatrix.f)/this.transformMatrix.d}}},{key:"findTarget",value:function(t){for(var e=this._objects.length-1;e>=0;e--){var r,i,n;if(!this._objects[e].notNeedFindTarget)if(null!==(r=this._objects[e])&&void 0!==r&&r.isPointInPath){if(this._objects[e].isPointInPath(t))return this._objects[e]}else{if(null===(i=this._objects[e])||void 0===i||null===(i=i.coords)||void 0===i||!i.length||null===(n=this._objects[e])||void 0===n||!n.coords)return;if(this._findTarget(t,this._objects[e].coords))return this._objects[e]}}}},{key:"destroy",value:function(){O(this.upperCanvas,"mousedown",this.handleMouseDown),O(this.upperCanvas,"mousemove",this.handleMouseMove),O(this.upperCanvas,"mouseup",this.handleMouseUp),O(this.upperCanvas,"mousewheel",this.handleMouseWheel)}}]),r}(b),j=function(t){a(r,t);var e=u(r);function r(t){var n;return i(this,r),s(c(n=e.call(this)),"type","object"),s(c(n),"scaleX",1),s(c(n),"scaleY",1),s(c(n),"skewX",0),s(c(n),"skewY",0),s(c(n),"translateX",0),s(c(n),"translateY",0),s(c(n),"isActive",!1),s(c(n),"lineCap","round"),s(c(n),"lineJoin","round"),s(c(n),"fill",""),s(c(n),"stroke",""),s(c(n),"opacity",1),s(c(n),"lineWidth",1),s(c(n),"left",0),s(c(n),"top",0),s(c(n),"width",0),s(c(n),"height",0),s(c(n),"angle",0),s(c(n),"originX",0),s(c(n),"originY",0),s(c(n),"offsetX",0),s(c(n),"offsetY",0),s(c(n),"coords",[]),s(c(n),"rotate",!1),s(c(n),"points",[]),s(c(n),"ratio",{x:1,y:1}),s(c(n),"cornerSize",10),s(c(n),"cornerStyle","rect"),s(c(n),"cornerBorderColor","#000"),s(c(n),"cornerColor",""),s(c(n),"cornerOpacity",1),s(c(n),"transformMatrix",{a:1,b:0,c:0,d:1,e:0,f:0}),s(c(n),"notNeedFindTarget",!1),s(c(n),"lockMove",!1),n.setOptions(t),n.id=function(){for(var t="ABCDEFGHIGKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz12334567890-_",e="",r=0;r<8;r++)e+=t[Math.floor(65*Math.random())];return e}(),n}return o(r,[{key:"setOptions",value:function(t){for(var e in t)this[e]=t[e];this.left&&this.top&&(this.originX=this.left+this.width/2,this.originY=this.top+this.height/2)}},{key:"render",value:function(t,e){this.ratio=e.ratio,this.transformMatrix=e.transformMatrix,t.save(),t.lineWidth=this.lineWidth/Math.abs(this.transformMatrix.a),t.lineCap=this.lineCap,t.lineJoin=this.lineJoin,t.globalAlpha=this.opacity,this.transform(t),this._render(t),t.restore(),this.setCoords&&this.setCoords(t),this.isActive&&this._drawControls(t),this.isActive&&this._drawBorders()}},{key:"transform",value:function(t){t.translate(this.originX,this.originY),t.rotate(this.angle)}},{key:"_render",value:function(t){}},{key:"_drawControls",value:function(t){var e,r=this;t.save(),this.coords.forEach((function(e){e.drawControl(t,r.angle)})),(null===(e=this.centerControlCoords)||void 0===e?void 0:e.length)&&this.centerControlCoords.forEach((function(e){e.drawControl(t,r.angle)})),t.restore()}},{key:"_drawBorders",value:function(){}},{key:"set",value:function(t,e){this._set(t,e)}},{key:"_set",value:function(t,e){this[t]=e}},{key:"strokeOrFill",value:function(t){this.stroke&&t.stroke(),this.fill&&t.fill()}},{key:"getCommonConfig",value:function(){return{cornerSize:this.cornerSize,cornerStyle:this.cornerStyle,cornerColor:this.cornerColor,cornerBorderColor:this.cornerBorderColor,cornerOpacity:this.cornerOpacity}}}]),r}(g),_=function(){function t(e){i(this,t),s(this,"cornerSize",10),s(this,"cornerStyle","square"),s(this,"cornerBorderColor","#000"),s(this,"cornerColor",""),s(this,"cornerOpacity",1),s(this,"left",0),s(this,"top",0),s(this,"center",null),s(this,"cursor","move"),s(this,"isEditing",!1),s(this,"mousemoveHandler",(function(){return null})),s(this,"mousedownHandler",(function(){return null})),s(this,"mouseupHandler",(function(){return null})),this.setOptions(e)}return o(t,[{key:"setOptions",value:function(t){for(var e in t)this[e]=t[e]}},{key:"drawControl",value:function(t,e){var r=t.getTransform();t.save(),t.translate(this.left,this.top),t.lineWidth=1/r.a,t.globalAlpha=this.cornerOpacity,t.rotate(e),t.beginPath(),t.strokeStyle=this.cornerBorderColor,t.fillStyle=this.cornerColor,"circle"===this.cornerStyle?t.arc(0,0,this.cornerSize/2/r.a,0,2*Math.PI,!1):t.rect(-this.cornerSize/2/r.a,-this.cornerSize/2/r.a,this.cornerSize/r.a,this.cornerSize/r.a),t.closePath(),this.cornerBorderColor&&t.stroke(),this.cornerColor&&t.fill(),t.restore()}},{key:"isPointInControl",value:function(t,e){var r=t.x,i=t.y,n=e.a,o=this.left,s=this.top;return r>=o-this.cornerSize/2/n&&r<=o+this.cornerSize/2/n&&i>=s-this.cornerSize/2/n&&i<=s+this.cornerSize/2/n}},{key:"setAngle",value:function(t){var e=this.center,r=e.x,i=e.y,n=(this.left-r)*Math.cos(t)-(this.top-i)*Math.sin(t)+r,o=(this.left-r)*Math.sin(t)+(this.top-i)*Math.cos(t)+i;this.left=n,this.top=o}},{key:"getCoords",value:function(){return{x:this.left,y:this.top}}},{key:"set",value:function(t,e){this[t]=e}},{key:"updatePointPosition",value:function(){}}]),t}(),A=function(t,e){var r=t.matrix,i=r.a,n=r.b,o=Math.atan2(n,i)/(Math.PI/180)+Math.atan2(e.y,e.x)/(Math.PI/180)+360,s=["e","se","s","sw","w","nw","n","ne","e"][Math.round(o%360/45)%4];return"".concat(s,"-resize")},Y=function(t,e,r,i,n){var o,s=C(0,r,i,n),a=s.width,h=s.originX,l=s.originY,c=s.angle,u=s.msPos,f=s.pointer;o="left-center"===t.base?(a+f.x-u.x)/e.width:(a-(f.x-u.x))/e.width,e.set("scaleX",o);var v=h+(f.x-u.x)/2,d={x:(v-h)*Math.cos(c)-(l-l)*Math.sin(c)+h,y:(v-h)*Math.sin(c)+(l-l)*Math.cos(c)+l};e.set("originX",d.x),e.set("originY",d.y)},I=function(t,e,r,i,n){var o,s=C(0,r,i,n),a=s.height,h=s.originX,l=s.originY,c=s.angle,u=s.msPos,f=s.pointer;o="center-top"===t.base?(a+f.y-u.y)/e.height:(a+u.y-f.y)/e.height,e.set("scaleY",o);var v=l+(f.y-u.y)/2,d={x:(h-h)*Math.cos(c)-(v-l)*Math.sin(c)+h,y:(h-h)*Math.sin(c)+(v-l)*Math.cos(c)+l};e.set("originX",d.x),e.set("originY",d.y)},X=function(t,e,r,i,n){var o,s,a=C(0,r,i,n),h=a.width,l=a.height,c=a.originX,u=a.originY,f=a.angle,v=a.msPos,d=a.pointer;switch(t.base){case"left-top":o=(h+d.x-v.x)/e.width,s=(l+d.y-v.y)/e.height;break;case"right-bottom":o=(h+v.x-d.x)/e.width,s=(l+v.y-d.y)/e.height;break;case"left-bottom":o=(h+d.x-v.x)/e.width,s=(l+v.y-d.y)/e.height;break;case"right-top":o=(h+v.x-d.x)/e.width,s=(l+d.y-v.y)/e.height}e.set("scaleX",o),e.set("scaleY",s);var y=u+(d.y-v.y)/2,p=c+(d.x-v.x)/2,g={x:(p-c)*Math.cos(f)-(y-u)*Math.sin(f)+c,y:(p-c)*Math.sin(f)+(y-u)*Math.cos(f)+u};e.set("originX",g.x),e.set("originY",g.y)},H=function(t,e,r,i,n){var o=C(0,r,i,n),s=o.originX,a=o.originY,h=o.cachePos;w.startPos||(w.startPos=n);var l=Math.atan2(w.startPos.y-a,w.startPos.x-s),c=Math.atan2(h.y-a,h.x-s)-l;e.set("angle",e.angle+c),w.startPos=h,e.angle,Math.PI,e.angle,Math.PI},E=function(){function t(e,r){i(this,t),this.x=e,this.y=r}return o(t,[{key:"add",value:function(t){return this.x+=t,this.y+=t,this}},{key:"addApplyPos",value:function(t){var e=t.x,r=t.y;return this.x+=e,this.y+=r,this}},{key:"del",value:function(t){return this.x-=t,this.y-=t,this}},{key:"delApplyPos",value:function(t){var e=t.x,r=t.y;return this.x-=e,this.y-=r,this}},{key:"rotate",value:function(t,e){return{x:(this.x-e.x)*Math.cos(t)-(this.y-e.y)*Math.sin(t)+e.x,y:(this.x-e.x)*Math.sin(t)+(this.y-e.y)*Math.cos(t)+e.y}}}]),t}(),z=function(t){a(n,t);var e=u(n);function n(t){var r;return i(this,n),s(c(r=e.call(this,t)),"textX",void 0),s(c(r),"textY",void 0),r.type="rect",r}return o(n,[{key:"_render",value:function(t){t.save();var e=-this.width*this.scaleX/2,r=-this.height*this.scaleY/2,i=this.width*this.scaleX,n=this.height*this.scaleY;t.beginPath(),t.lineWidth=this.lineWidth/Math.abs(this.transformMatrix.a),t.strokeStyle=this.stroke,t.fillStyle=this.fill,t.rect(e,r,i,n),t.closePath(),this.strokeOrFill(t),t.restore(),this.matrix=t.getTransform()}},{key:"setCoords",value:function(t){var e=this,i=this.width*this.scaleX,n=this.height*this.scaleY,o=this.originX,s=this.originY,a={x:this.originX,y:this.originY},h=this.getCommonConfig();if("rect"===this.type){this.coords=[new _(r({x:-i/2,y:-n/2,left:o-i/2,top:s-n/2,target:this,base:"right-bottom",cursorHandler:A,mousemoveHandler:X},h)),new _(r({x:0,y:-n/2,left:o,top:s-n/2,target:this,base:"center-bottom",cursorHandler:A,mousemoveHandler:I},h)),new _(r({x:i/2,y:-n/2,left:o+i/2,top:s-n/2,target:this,base:"left-bottom",cursorHandler:A,mousemoveHandler:X},h)),new _(r({x:i/2,y:0,left:o+i/2,top:s,target:this,base:"left-center",cursorHandler:A,mousemoveHandler:Y},h)),new _(r({x:i/2,y:n/2,left:o+i/2,top:s+n/2,target:this,base:"left-top",cursorHandler:A,mousemoveHandler:X},h)),new _(r({x:0,y:n/2,left:o,top:s+n/2,target:this,base:"center-top",cursorHandler:A,mousemoveHandler:I},h)),new _(r({x:-i/2,y:n/2,left:o-i/2,top:s+n/2,target:this,base:"right-top",cursorHandler:A,mousemoveHandler:X},h)),new _(r({x:-i/2,y:0,left:o-i/2,top:s,target:this,base:"right-center",cursorHandler:A,mousemoveHandler:Y},h))];var l=this.coords.map((function(t){return t.getCoords()})),c=Math.min.apply(Math,v(l.map((function(t){return t.x})))),u=Math.min.apply(Math,v(l.map((function(t){return t.y}))));this.textX=c,this.textY=u,this.rotate&&this.coords.push(new _(r({left:o,top:u-40,target:this,base:"center-center",cursor:"crosshair",mousemoveHandler:H},h)))}this.coords.forEach((function(t,r){var i=new E(t.left,t.top).rotate(e.angle,a),n=i.x,o=i.y;t.left=n,t.top=o})),this.points=[this.coords[0].getCoords(),this.coords[2].getCoords(),this.coords[4].getCoords(),this.coords[6].getCoords()]}}]),n}(j),R=function(t){a(n,t);var e=u(n);function n(t){var r;return i(this,n),s(c(r=e.call(this,t)),"centerControlPoints",[]),s(c(r),"needCenterControl",!0),s(c(r),"centerPointsStyle","square"),s(c(r),"centerPointsSize",10),s(c(r),"centerPointsStroke","#f00"),s(c(r),"centerPointsFill","#fff"),r.type="polygon",r.setOptions(t),r}return o(n,[{key:"_render",value:function(t){var e=this.transformMatrix;e.a,e.b,e.c,e.d,e.e,e.f,t.save(),t.beginPath(),t.strokeStyle=this.stroke||"#000",t.fillStyle=this.fill||"#000",this.points.forEach((function(e,r){t[r?"lineTo":"moveTo"](e.x,e.y)})),t.closePath(),this.strokeOrFill(t),t.restore(),this.drawArrow(t,this.points[0].x,this.points[0].y,(this.points[0].x+this.points[1].x)/2,(this.points[0].y+this.points[1].y)/2),this.needCenterControl&&this.renderCenterControl(t)}},{key:"drawArrow",value:function(t,e,r,i,n){t.save(),t.beginPath();var o=function(t,e,r,i){var n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:50,o=arguments.length>5?arguments[5]:void 0,s=Math.atan2(i-e,r-t);return[r-n*Math.cos(s+o*Math.PI/180),i-n*Math.sin(s+o*Math.PI/180),r-n*Math.cos(s-o*Math.PI/180),i-n*Math.sin(s-o*Math.PI/180)]},s=f(o(e,r,i,n,15,30),4),a=s[0],h=s[1],l=s[2],c=s[3],u=this.transformMatrix;u.a,u.b,u.c,u.d,u.e,u.f,t.moveTo(a,h),t.lineTo(i,n),t.lineTo(l,c),t.lineWidth=5/this.transformMatrix.a,t.strokeStyle=this.stroke,t.fillStyle="#000",t.globalAlpha=1,t.stroke(),t.closePath(),t.restore()}},{key:"setCoords",value:function(){var t=this;this.coords=this.points.map((function(e,i){return new _(r({left:e.x,top:e.y,target:t,cursor:"pointer",index:i,mousemoveHandler:k},t.getCommonConfig()))}))}},{key:"renderCenterControl",value:function(t){var e=this;this.centerControlPoints=this.points.map((function(t,r){return[t,e.points[(r+1)%e.points.length]]})).map((function(t){var e=f(t,2),r=e[0],i=e[1];return{x:(r.x+i.x)/2,y:(r.y+i.y)/2}})),this.centerControlCoords=this.centerControlPoints.map((function(t,r){return new _({left:t.x,top:t.y,target:e,cursor:"copy",index:r,cornerStyle:e.centerPointsStyle,cornerSize:e.centerPointsSize,cornerBorderColor:e.centerPointsStroke,cornerColor:e.centerPointsFill,mousedownHandler:M})}))}}]),n}(j),L=function(t){a(n,t);var e=u(n);function n(t){var r;return i(this,n),s(c(r=e.call(this,t)),"centerControlPoints",[]),r.type="line",r.setOptions(t),r}return o(n,[{key:"_render",value:function(t){t.save(),t.beginPath(),t.strokeStyle=this.stroke||"#000",t.fillStyle=this.fill||"#000",this.points.forEach((function(e,r){t[r?"lineTo":"moveTo"](e.x,e.y)})),t.stroke(),t.closePath(),t.restore(),this.renderCenterControl(t)}},{key:"setCoords",value:function(){var t=this;this.coords=this.points.map((function(e,i){return new _(r({left:e.x,top:e.y,target:t,cursor:"pointer",index:i,mousemoveHandler:k},t.getCommonConfig()))}))}},{key:"renderCenterControl",value:function(){var t=this;this.centerControlPoints=this.points.map((function(e,r){return[e,t.points[(r+1)%t.points.length]]})).map((function(t){var e=f(t,2),r=e[0],i=e[1];return{x:(r.x+i.x)/2,y:(r.y+i.y)/2}})),this.centerControlPoints=this.centerControlPoints.slice(0,this.centerControlPoints.length-1),this.centerControlCoords=this.centerControlPoints.map((function(e,r){return new _({left:e.x,top:e.y,target:t,cursor:"copy",index:r,mousedownHandler:M})}))}},{key:"isPointInPath",value:function(t){for(var e=this,r=this.points.map((function(t,r){return[t,e.points[(r+1)%e.points.length]]})),i=0,n=r.length;i<n;i++){var o=r[i][0],s=r[i][1],a=Math.sqrt(Math.pow(t.x-o.x,2)+Math.pow(t.y-o.y,2));if(Math.sqrt(Math.pow(t.x-s.x,2)+Math.pow(t.y-s.y,2))+a-Math.sqrt(Math.pow(s.x-o.x,2)+Math.pow(s.y-o.y,2))<.5/this.transformMatrix.a)return!0}}}]),n}(j),W=function(t){a(r,t);var e=u(r);function r(t){var n;return i(this,r),(n=e.call(this,t)).type="point",n}return o(r,[{key:"_render",value:function(t){t.save(),t.beginPath(),t.arc(0,0,this.radius/this.transformMatrix.a,0,2*Math.PI),t.strokeStyle=this.stroke,t.fillStyle=this.fill,t.closePath(),this.strokeOrFill(t),t.restore()}},{key:"setCoords",value:function(){this.coords=[new _({left:this.originX,top:this.originY,target:this,cursor:"pointer",mousemoveHandler:P})]}},{key:"isPointInPath",value:function(t){var e=this.radius/this.transformMatrix.a;if(t.x<this.left+e&&t.y<this.top+e&&t.x>this.left-e&&t.y>this.top-e)return!0}}]),r}(j),B=function(t){a(r,t);var e=u(r);function r(t){var n;i(this,r),n=e.call(this,t);var o=t.points;return n.width=Math.abs(o[0].x-o[1].x),n.height=Math.abs(o[0].y-o[1].y),n.type="arrow",n}return o(r,[{key:"_render",value:function(t){var e=t.getTransform();t.save(),t.beginPath();var r=this.points[0],i=r.x,n=r.y,o=this.points[1],s=o.x,a=o.y,h=function(t,e,r,i){var n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:50,o=arguments.length>5?arguments[5]:void 0,s=Math.atan2(i-e,r-t);return[r-n*Math.cos(s+o*Math.PI/180),i-n*Math.sin(s+o*Math.PI/180),r-n*Math.cos(s-o*Math.PI/180),i-n*Math.sin(s-o*Math.PI/180)]}(i,n,s,a,20,30),l=f(h,4),c=l[0],u=l[1],v=l[2],d=l[3];t.moveTo(i,n),t.lineTo(s,a),t.moveTo(c,u),t.lineTo(s,a),t.lineTo(v,d),t.lineWidth=this.lineWidth/e.a,t.strokeStyle=this.stroke,t.globalAlpha=this.opacity,t.stroke(),t.closePath(),t.restore()}},{key:"setCoords",value:function(t){var e,r,i=this.width*this.scaleX,n=this.height*this.scaleY,o={x:e=this.points[0].x<this.points[1].x?this.points[0].x+this.width/2:this.points[1].x+this.width/2,y:r=this.points[0].y<this.points[1].y?this.points[0].y+this.height/2:this.points[1].y+this.height/2};this.coords=[new _({x:e-i/2,y:r-n/2,center:o,target:this,base:"right-bottom",cursor:"not-allowed"}),new _({x:e,y:r-n/2,center:o,target:this,base:"center-bottom",cursor:"not-allowed"}),new _({x:e+i/2,y:r-n/2,center:o,target:this,base:"left-bottom",cursor:"not-allowed"}),new _({x:e+i/2,y:r,center:o,target:this,base:"left-center",cursor:"not-allowed"}),new _({x:e+i/2,y:r+n/2,center:o,target:this,base:"left-top",cursor:"not-allowed"}),new _({x:e,y:r+n/2,center:o,target:this,base:"center-top",cursor:"not-allowed"}),new _({x:e-i/2,y:r+n/2,center:o,target:this,base:"right-top",cursor:"not-allowed"}),new _({x:e-i/2,y:r,center:o,target:this,base:"right-center",cursor:"not-allowed"})],this.isActive&&(t.beginPath(),this.coords.forEach((function(e,r){t[r?"lineTo":"moveTo"](e.x,e.y)})),t.closePath(),t.stroke())}}]),r}(j),D=function(t){a(r,t);var e=u(r);function r(t){var n;return i(this,r),s(c(n=e.call(this,t)),"xScales",[]),s(c(n),"yScales",[]),s(c(n),"coords",[]),s(c(n),"fontSize",12),n.type="Ruler",n.fontSize=t.fontSize,n}return o(r,[{key:"_render",value:function(t){var e,r,i,n,o;t.strokeStyle=this.stroke,t.fillStyle=this.stroke,this.transformMatrix.a>5?(r=t.canvas.width,i=t.canvas.height,n=1,o=10):this.transformMatrix.a<.6?(r=t.canvas.width/50,i=t.canvas.height/50,n=50,o=100):(r=t.canvas.width/5,i=t.canvas.height/5,n=5,o=50),t.save(),t.setTransform(this.transformMatrix.a,0,0,this.transformMatrix.a,this.transformMatrix.e,0),e=this.fontSize/this.transformMatrix.a,t.font="bold ".concat(e,"px Alibaba_PuHuiTi_Regular");for(var s=0;s<=r;s++){if(t.beginPath(),t.moveTo(s*n,0),s*n%o==0){t.lineTo(s*n,15/this.transformMatrix.a);var a=t.measureText(s*n).width;t.fillText(s*n,s*n-a/2,30/this.transformMatrix.a)}else t.lineTo(s*n,5/this.transformMatrix.a);t.stroke(),t.closePath()}t.restore(),t.save(),t.setTransform(this.transformMatrix.a,0,0,this.transformMatrix.a,0,this.transformMatrix.f),e=this.fontSize/this.transformMatrix.a,t.font="bold ".concat(e,"px Alibaba_PuHuiTi_Regular");for(var h=0;h<=i;h++){if(t.beginPath(),t.moveTo(0,h*n),h*n%o==0)t.lineTo(15/this.transformMatrix.a,h*n),t.measureText(h*n).width,t.fillText(h*n,20/this.transformMatrix.a,h*n+5/this.transformMatrix.a);else t.lineTo(5/this.transformMatrix.a,h*n);t.stroke(),t.closePath()}t.restore()}}]),r}(j),q=function(t){a(r,t);var e=u(r);function r(t){var n;return i(this,r),s(c(n=e.call(this,t)),"fillText",!0),s(c(n),"relationShipId",""),s(c(n),"fontSize",20),s(c(n),"parent",null),n.type="Text",n.fillText=t.fillText,n.fontSize=t.fontSize,n}return o(r,[{key:"_render",value:function(t){t.save(),t.translate(this.parent.textX,this.parent.textY);var e=this.fontSize/this.transformMatrix.a;t.font="bold ".concat(e,"px Alibaba_PuHuiTi_Regular"),t.beginPath(),t.fillStyle=this.fill,this.fillText&&t.fillText(this.text,0,-5/this.transformMatrix.a),t.closePath(),t.restore()}},{key:"isPointInPath",value:function(){}}]),r}(j),F=function(t){a(r,t);var e=u(r);function r(t){var n;return i(this,r),(n=e.call(this,t)).type="crosshairline",n}return o(r,[{key:"_render",value:function(t){var e=this.points.x*this.transformMatrix.a+this.transformMatrix.e,r=this.points.y*this.transformMatrix.a+this.transformMatrix.f;t.save(),t.setTransform(1,0,0,1,0,0),t.lineWidth=1,t.strokeStyle=this.stroke,t.beginPath(),t.moveTo(e,0),t.lineTo(e,t.canvas.height),t.stroke(),t.closePath(),t.restore(),t.save(),t.lineWidth=1,t.setTransform(1,0,0,1,0,0),t.strokeStyle=this.stroke,t.beginPath(),t.moveTo(0,r),t.lineTo(t.canvas.width,r),t.stroke(),t.closePath(),t.restore()}}]),r}(j);t.Arrow=B,t.Canvas=T,t.CrosshairLine=F,t.DrawObject=j,t.Line=L,t.Matrix=m,t.Point=W,t.Polygon=R,t.Rect=z,t.Ruler=D,t.Text=q}));
