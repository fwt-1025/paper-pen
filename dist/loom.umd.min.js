!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Loom={})}(this,(function(t){"use strict";function e(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,r)}return i}function i(t){for(var i=1;i<arguments.length;i++){var r=null!=arguments[i]?arguments[i]:{};i%2?e(Object(r),!0).forEach((function(e){s(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):e(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,y(r.key),r)}}function o(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function s(t,e,i){return(e=y(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&l(t,e)}function h(t){return h=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},h(t)}function l(t,e){return l=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},l(t,e)}function c(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function u(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var i,r=h(t);if(e){var n=h(this).constructor;i=Reflect.construct(r,arguments,n)}else i=r.apply(this,arguments);return function(t,e){if(e&&("object"==typeof e||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return c(t)}(this,i)}}function f(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var r,n,o,s,a=[],h=!0,l=!1;try{if(o=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;h=!1}else for(;!(h=(r=o.call(i)).done)&&(a.push(r.value),a.length!==e);h=!0);}catch(t){l=!0,n=t}finally{try{if(!h&&null!=i.return&&(s=i.return(),Object(s)!==s))return}finally{if(l)throw n}}return a}}(t,e)||d(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function v(t){return function(t){if(Array.isArray(t))return p(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||d(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function d(t,e){if(t){if("string"==typeof t)return p(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?p(t,e):void 0}}function p(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,r=new Array(e);i<e;i++)r[i]=t[i];return r}function y(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var r=i.call(t,e||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}var g=function(){function t(){r(this,t),this.eventList={}}return o(t,[{key:"on",value:function(t,e){this.eventList[t]=this.eventList[t]||[],this.eventList[t].push(e)}},{key:"emit",value:function(t){for(var e=this,i=arguments.length,r=new Array(i>1?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];this.eventList[t]&&this.eventList[t].forEach((function(t){t.call.apply(t,[e].concat(r))}))}},{key:"off",value:function(t,e){this.eventList[t]=this.eventList[t].filter((function(t){return t!==e}))}}]),t}(),m=function(){function t(){r(this,t),s(this,"a",1),s(this,"b",0),s(this,"c",0),s(this,"d",1),s(this,"e",0),s(this,"f",0)}return o(t,[{key:"translate",value:function(t,e){return this.transform(1,0,0,1,t,e)}},{key:"scaleU",value:function(t){return this.transform(t,0,0,t,0,0)}},{key:"rotate",value:function(t){var e=Math.cos(t),i=Math.sin(t);return this.transform(e,i,-i,e,0,0)}},{key:"rotateAngle",value:function(t){var e=t/180*Math.PI;return this.rotate(e)}},{key:"transform",value:function(t,e,i,r,n,o){var s=this,a=this.a,h=this.b,l=this.c,c=this.d,u=this.e,f=this.f;return s.a=a*t+l*e,s.b=h*t+c*e,s.c=a*i+l*r,s.d=h*i+c*r,s.e=a*n+l*o+u,s.f=h*n+c*o+f,s}},{key:"applyToPoint",value:function(t,e){var i=this;return{x:t*i.a+e*i.c+i.e,y:t*i.b+e*i.d+i.f}}},{key:"clone",value:function(){return{a:this.a,b:this.b,c:this.c,d:this.d,e:this.e,f:this.f}}}]),t}(),x={scaleX:1,scaleY:1,angle:0,skewX:0,skewY:0,translateX:0,translateY:0,width:0,height:0,left:0,top:0,originX:"left",originY:"top"},b=function(t){a(i,t);var e=u(i);function i(t,n){var o;return r(this,i),s(c(o=e.call(this)),"el",null),s(c(o),"width",0),s(c(o),"height",0),s(c(o),"lowerCanvas",null),s(c(o),"lowerContext",null),s(c(o),"upperCanvas",null),s(c(o),"canvasContainer",null),s(c(o),"transform",[1,0,0,1,0,0]),s(c(o),"transformMatrix",new m),s(c(o),"defaultTransform",x),s(c(o),"_objects",[]),s(c(o),"_activeObject",null),s(c(o),"selection",!0),s(c(o),"selectionLineWidth",1),s(c(o),"selectionColor","#00f"),s(c(o),"selectionBorderColor","#000"),s(c(o),"selectionOpacity",.3),s(c(o),"background",""),s(c(o),"backgroundImage",new Image),s(c(o),"baseWidth",!1),s(c(o),"baseHeight",!0),s(c(o),"ratio",{x:1,y:1}),s(c(o),"pixelSize",{w:0,h:0}),o.setOptions(n),o.el=t,o.initLowerCanvas(),o.initCanvasContainer(),o.initUpperCanvas(),o}return o(i,[{key:"setOptions",value:function(t){for(var e in t)this[e]=t[e]}},{key:"initLowerCanvas",value:function(){if(!this.el)throw new Error("Canvas must have an 'el' parameter and cannot be empty");"string"==typeof this.el?this.lowerCanvas=document.querySelector(this.el):this.lowerCanvas=this.el,this.setCanvasStyles(this.lowerCanvas),this.lowerCanvas.classList.add("lower-canvas"),this.lowerContext=this.lowerCanvas.getContext("2d")}},{key:"initCanvasContainer",value:function(){var t;this.canvasContainer=document.createElement("div"),this.canvasContainer.classList.add("canvas-container"),null===(t=this.lowerCanvas)||void 0===t||null===(t=t.parentNode)||void 0===t||t.replaceChild(this.canvasContainer,this.lowerCanvas),this.canvasContainer.appendChild(this.lowerCanvas),this.canvasContainer.style.position="relative",this.canvasContainer.style.width=this.width+"px",this.canvasContainer.style.height=this.height+"px"}},{key:"initUpperCanvas",value:function(){var t;this.upperCanvas=document.createElement("canvas"),this.upperCanvas.classList.add("upper-canvas"),this.upperContext=this.upperCanvas.getContext("2d"),this.setCanvasStyles(this.upperCanvas),null===(t=this.canvasContainer)||void 0===t||t.appendChild(this.upperCanvas)}},{key:"setCanvasStyles",value:function(t){var e={position:"absolute",top:"0px",left:"0px",width:this.width+"px",height:this.height+"px"};Object.entries(e).forEach((function(e){var i=f(e,2),r=i[0],n=i[1];t.style.setProperty(r,n)})),t.width=this.width,t.height=this.height}},{key:"add",value:function(){for(var t,e=this,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];r.forEach((function(t){t.setCoords&&t.setCoords(e.lowerContext,e)})),(t=this._objects).push.apply(t,r),this.requestRenderAll()}},{key:"remove",value:function(t){this._objects=this._objects.filter((function(e){return e.id!==t.id}))}},{key:"requestRenderAll",value:function(){window.requestAnimationFrame(this._renderAll.bind(this))}},{key:"_renderAll",value:function(){var t=this;this.clearContext(this.lowerContext),this.backgroundImage&&this.drawBackground(this.lowerContext),this.lowerContext.save(),this._objects.forEach((function(e){e.render(t.lowerContext,t)})),this.lowerContext.restore()}},{key:"setBackground",value:function(t,e){var i=this;if("string"==typeof t)return this.backgroundImage.src=t,void(this.backgroundImage.onload=function(){i.pixelSize={w:i.backgroundImage.naturalWidth,h:i.backgroundImage.naturalHeight};var t=i.backgroundImage.naturalWidth/i.backgroundImage.naturalHeight;i.baseWidth?(i.width=i.width,i.height=i.width/t):i.baseHeight&&(i.width=i.height*t,i.height=i.height),null!=e&&e.width&&null!=e&&e.height&&(i.width=e.width,i.height=e.height),i.setCanvasStyles(i.lowerCanvas),i.setCanvasStyles(i.upperCanvas),i.emit("img:load",i),i.requestRenderAll()});this.backgroundImage=t,this.requestRenderAll()}},{key:"drawBackground",value:function(t){t.save(),t.drawImage(this.backgroundImage,0,0,this.width,this.height),t.restore()}},{key:"clearContext",value:function(t){t.save(),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,this.width,this.height),t.restore()}},{key:"renderTop",value:function(){var t=this.upperContext;this.clearContext(t),this.renderTopLayer(t),this.emit("after:render",{ctx:t})}},{key:"renderTopLayer",value:function(t){t.save(),t.globalAlpha=this.selectionOpacity,this.selection&&this._groupSelector&&(this._drawSelection(t),this.contextTopDirty=!0),t.restore()}},{key:"_drawSelection",value:function(t){var e=this._groupSelector,i=e.x,r=e.y,n=e.deltaX,o=e.deltaY,s=this.transformMatrix,a=s.a;s.b,s.c,s.d,i=i*a+s.e,r=r*a+s.f,this.selectionColor&&(t.fillStyle=this.selectionColor,t.fillRect(i,r,n*a,o*a)),this.selectionLineWidth&&this.selectionBorderColor&&(t.lineWidth=this.selectionLineWidth,t.strokeStyle=this.selectionBorderColor,t.strokeRect(i,r,n*a,o*a))}},{key:"setDefaultTransform",value:function(t,e){this.defaultTransform={target:e,scaleX:e.scaleX,scaleY:e.scaleY,originX:e.originX,originY:e.originY,width:e.width*e.scaleX,offsetX:t.x-e.left,offsetY:t.y-e.top,left:e.left,top:e.top,height:e.height*e.scaleY,angle:e.angle}}},{key:"set",value:function(t,e){this[t]=e}},{key:"_findTarget",value:function(t,e){for(var i=this,r=t,n=e.map((function(t){return t.getCoords(i.lowerContext)})),o=(n=e[0].target.rotate?n.slice(0,7):n).map((function(t,e){return[t,n[(e+1)%n.length]]})),s=r.x,a=r.y,h=!1,l=0,c=o.length;l<c;l++){var u=o[l][0].x,f=o[l][0].y,v=o[l][1].x,d=o[l][1].y;if(u===s&&f===a||v===s&&d===a)return!0;if(f===d&&f===a&&(u>s&&v<s||u<s&&v>s))return!0;if(f<a&&d>=a||f>=a&&d<a){var p=u+(a-f)*(v-u)/(d-f);if(p===s)return!0;p>s&&(h=!h)}}return!!h}},{key:"setActiveObject",value:function(t){t?this._activeObject=t:(this._activeObject&&this._activeObject.set("isActive",!1),this._activeObject=null)}},{key:"getActiveObject",value:function(){return this._activeObject}},{key:"setCursorFromTarget",value:function(t){this.setCursor("pointer")}},{key:"setCursor",value:function(t){this.upperCanvas.style.cursor=t}},{key:"resetActive",value:function(){this._objects.forEach((function(t){t.set("isActive",!1)}))}},{key:"destroy",value:function(){}},{key:"toObjects",value:function(){return{objects:this._objects,pixelSize:this.pixelSize}}}]),i}(g),w=function(t,e,i,r,n){var o,s=S(e,i,r,n),a=s.width,h=s.originX,l=s.originY,c=s.angle,u=s.msPos,f=s.pointer;o="left-center"===t.base?(a+f.x-u.x)/e.width:(a-(f.x-u.x))/e.width,e.set("scaleX",o);var v=h+(f.x-u.x)/2,d={x:(v-h)*Math.cos(c)-(l-l)*Math.sin(c)+h,y:(v-h)*Math.sin(c)+(l-l)*Math.cos(c)+l};e.set("originX",d.x),e.set("originY",d.y)},C=function(t,e,i,r,n){var o,s=S(e,i,r,n),a=s.height,h=s.originX,l=s.originY,c=s.angle,u=s.msPos,f=s.pointer;o="center-top"===t.base?(a+f.y-u.y)/e.height:(a+u.y-f.y)/e.height,e.set("scaleY",o);var v=l+(f.y-u.y)/2,d={x:(h-h)*Math.cos(c)-(v-l)*Math.sin(c)+h,y:(h-h)*Math.sin(c)+(v-l)*Math.cos(c)+l};e.set("originX",d.x),e.set("originY",d.y)},k=function(t,e,i,r,n){var o,s,a=S(e,i,r,n),h=a.width,l=a.height,c=a.originX,u=a.originY,f=a.angle,v=a.msPos,d=a.pointer;switch(t.base){case"left-top":o=(h+d.x-v.x)/e.width,s=(l+d.y-v.y)/e.height;break;case"right-bottom":o=(h+v.x-d.x)/e.width,s=(l+v.y-d.y)/e.height;break;case"left-bottom":o=(h+d.x-v.x)/e.width,s=(l+v.y-d.y)/e.height;break;case"right-top":o=(h+v.x-d.x)/e.width,s=(l+d.y-v.y)/e.height}e.set("scaleX",o),e.set("scaleY",s);var p=u+(d.y-v.y)/2,y=c+(d.x-v.x)/2,g={x:(y-c)*Math.cos(f)-(p-u)*Math.sin(f)+c,y:(y-c)*Math.sin(f)+(p-u)*Math.cos(f)+u};e.set("originX",g.x),e.set("originY",g.y)},M={startPos:null},P=function(t,e,i,r,n){var o=S(e,i,r,n),s=o.originX,a=o.originY,h=o.cachePos;M.startPos||(M.startPos=n);var l=Math.atan2(M.startPos.y-a,M.startPos.x-s),c=Math.atan2(h.y-a,h.x-s)-l;e.set("angle",e.angle+c),M.startPos=h,e.angle,Math.PI,e.angle,Math.PI};function S(t,e,i,r){var n=i.width,o=i.height,s=i.left,a=i.top,h=i.originX,l=i.originY,c=i.angle,u=r.x,f=r.y,v=JSON.parse(JSON.stringify(e));return{width:n,height:o,left:s,top:a,originX:h,originY:l,angle:c,msPos:{x:(u-h)*Math.cos(-c)-(f-l)*Math.sin(-c)+h,y:(u-h)*Math.sin(-c)+(f-l)*Math.cos(-c)+l},pointer:e={x:(e.x-h)*Math.cos(-c)-(e.y-l)*Math.sin(-c)+h,y:(e.x-h)*Math.sin(-c)+(e.y-l)*Math.cos(-c)+l},cachePos:v}}var O=function(t,e,i,r,n){t.left=i.x,t.top=i.y,e.points[t.index]=t.getCoords()},T=function(t,e,i){e.points.splice(t.index+1,0,t.getCoords())},j=function(t,e,i,r,n){e.lockMove||(M.startPos||(M.startPos=n),null!=e&&e.left&&null!=e&&e.top?(e.left=e.originX+=i.x-M.startPos.x,e.top=e.originY+=i.y-M.startPos.y):e.points.forEach((function(t){t.x+=i.x-M.startPos.x,t.y+=i.y-M.startPos.y})),M.startPos=i)},_=function(t,e,i){t.addEventListener(e,i)},A=function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];return t.removeEventListener.apply(t,i)},Y=function(t){a(i,t);var e=u(i);function i(t,n){var o;return r(this,i),s(c(o=e.call(this,t,n||{})),"targetCornerIndex",-1),s(c(o),"mousedownPos",{x:0,y:0}),s(c(o),"corner",null),s(c(o),"preventDefault",!0),s(c(o),"_groupSelector",null),s(c(o),"selection",!0),s(c(o),"skipFindTarget",!1),o.initBindEvents(),o.initEvents(),o}return o(i,[{key:"initBindEvents",value:function(){var t=this;["handleMouseDown","handleMouseMove","handleMouseUp","handleMouseWheel"].forEach((function(e){t[e]=t[e].bind(t)}))}},{key:"initEvents",value:function(){this.upperCanvas instanceof HTMLElement&&(_(this.upperCanvas,"mousedown",this.handleMouseDown),_(this.upperCanvas,"mousemove",this.handleMouseMove),_(this.upperCanvas,"mouseup",this.handleMouseUp),_(this.upperCanvas,"mousewheel",this.handleMouseWheel),this.preventDefault&&_(this.upperCanvas,"contextmenu",(function(t){t.preventDefault()})))}},{key:"handleMouseDown",value:function(t){var e=this.getMousePosInfo(t);if(2!==t.button){var i=this.getPointer(e);this.mousedownPos=i;var r=this.getActiveObject();if(this.corner&&r&&!this.skipFindTarget)return this.corner.isEditing=!0,this.setDefaultTransform(i,r),this.corner.mousedownHandler&&this.corner.mousedownHandler(this.corner,this.corner.target,this.mousedownPos),void this.requestRenderAll();if(!this.corner&&!this.skipFindTarget){var n=this.findTarget(i);n&&n!==r&&(r&&r.set("isActive",!1),this.setActiveObject(n),n.set("isActive",!0)),n||this.setActiveObject(null),this.requestRenderAll()}this.emit("mouse:down",e),this._activeObject&&!this.skipFindTarget&&(this.objectMoving=!0),this.selection&&!this.getActiveObject()&&(this._groupSelector={x:i.x,y:i.y,deltaX:0,deltaY:0}),_(this.upperCanvas,"mousemove",this.handleMouseMove),this.requestRenderAll()}else this.emit("mouse:down",e)}},{key:"handleMouseMove",value:function(t){var e,i=this.getMousePosInfo(t),r=this.getPointer(i);if(this._activeObject&&!this.skipFindTarget&&(null==this||null===(e=this.corner)||void 0===e||!e.isEditing)){for(var n,o=0;o<this._activeObject.coords.length;o++){var s=this._activeObject.coords[o];if(s.isPointInControl(this.getPointer(t),this.transformMatrix)){this.corner=s,this.setCursor(s.cursor);break}this.setCursor("default"),this.corner=null}if(null!==(n=this._activeObject.centerControlCoords)&&void 0!==n&&n.length&&!this.corner)for(var a=0;a<this._activeObject.centerControlCoords.length;a++){var h=this._activeObject.centerControlCoords[a];if(h.isPointInControl(this.getPointer(t),this.transformMatrix)){this.corner=h,this.setCursor(h.cursor);break}this.setCursor("default"),this.corner=null}}this.corner&&this.corner.isEditing&&!this.skipFindTarget&&(this.corner.mousemoveHandler&&this.corner.mousemoveHandler(this.corner,this.corner.target,r,this.defaultTransform,this.mousedownPos),this.requestRenderAll()),this.objectMoving&&this._activeObject&&(j(this.corner,this._activeObject,r,this.defaultTransform,this.mousedownPos),this.requestRenderAll());var l=this._groupSelector;if(l&&(l.deltaX=r.x-l.x,l.deltaY=r.y-l.y,this.renderTop()),!this.corner){var c=this.findTarget(r);c?(this.setCursor("move"),i.target=c):this.setCursor("default")}this.emit("mouse:move",i)}},{key:"handleMouseUp",value:function(t){var e=this.getMousePosInfo(t);this.emit("mouse:up",e),this.objectMoving=!1,M.startPos=null,this._groupSelector=null,2!==t.button&&(this.corner=null,this.contextTopDirty&&this.clearContext(this.upperContext))}},{key:"handleMouseWheel",value:function(t){var e=this.getMousePosInfo(t);this.emit("mouse:wheel",e)}},{key:"getMousePosInfo",value:function(t){return{clientX:t.clientX,clientY:t.clientY,type:t.type,button:t.button,offsetX:t.offsetX,offsetY:t.offsetY,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,deltaY:t.deltaY}}},{key:"getPointer",value:function(t){var e,i=null===(e=this.upperCanvas)||void 0===e?void 0:e.getBoundingClientRect();return{x:(t.clientX-i.left-this.transformMatrix.e)/this.transformMatrix.a,y:(t.clientY-i.top-this.transformMatrix.f)/this.transformMatrix.d}}},{key:"findTarget",value:function(t){for(var e=this._objects.length-1;e>=0;e--){var i,r,n;if(!this._objects[e].notNeedFindTarget)if(null!==(i=this._objects[e])&&void 0!==i&&i.isPointInPath){if(this._objects[e].isPointInPath(t))return this._objects[e]}else{if(null===(r=this._objects[e])||void 0===r||null===(r=r.coords)||void 0===r||!r.length||null===(n=this._objects[e])||void 0===n||!n.coords)return;if(this._findTarget(t,this._objects[e].coords))return this._objects[e]}}}},{key:"destroy",value:function(){A(this.upperCanvas,"mousedown",this.handleMouseDown),A(this.upperCanvas,"mousemove",this.handleMouseMove),A(this.upperCanvas,"mouseup",this.handleMouseUp),A(this.upperCanvas,"mousewheel",this.handleMouseWheel)}}]),i}(b),X=function(){function t(e){r(this,t),s(this,"type","object"),s(this,"scaleX",1),s(this,"scaleY",1),s(this,"skewX",0),s(this,"skewY",0),s(this,"translateX",0),s(this,"translateY",0),s(this,"isActive",!1),s(this,"lineCap","round"),s(this,"lineJoin","round"),s(this,"fill",""),s(this,"stroke",""),s(this,"opacity",1),s(this,"lineWidth",1),s(this,"left",0),s(this,"top",0),s(this,"width",0),s(this,"height",0),s(this,"angle",0),s(this,"originX",0),s(this,"originY",0),s(this,"offsetX",0),s(this,"offsetY",0),s(this,"coords",[]),s(this,"rotate",!1),s(this,"points",[]),s(this,"ratio",{x:1,y:1}),s(this,"cornerSize",10),s(this,"cornerStyle","rect"),s(this,"cornerBorderColor","#000"),s(this,"cornerColor",""),s(this,"cornerOpacity",1),s(this,"transformMatrix",{a:1,b:0,c:0,d:1,e:0,f:0}),s(this,"notNeedFindTarget",!1),s(this,"lockMove",!1),this.setOptions(e),this.id=function(){for(var t="ABCDEFGHIGKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz12334567890-_",e="",i=0;i<8;i++)e+=t[Math.floor(65*Math.random())];return e}()}return o(t,[{key:"setOptions",value:function(t){for(var e in t)this[e]=t[e];this.left&&this.top&&(this.originX=this.left+this.width/2,this.originY=this.top+this.height/2)}},{key:"render",value:function(t,e){this.ratio=e.ratio,this.transformMatrix=e.transformMatrix,t.save(),t.lineWidth=this.lineWidth/Math.abs(this.transformMatrix.a),t.lineCap=this.lineCap,t.lineJoin=this.lineJoin,t.globalAlpha=this.opacity,this.transform(t),this._render(t),t.restore(),this.setCoords&&this.setCoords(t),this.isActive&&this._drawControls(t),this.isActive&&this._drawBorders()}},{key:"transform",value:function(t){t.translate(this.originX,this.originY),t.rotate(this.angle)}},{key:"_render",value:function(t){}},{key:"_drawControls",value:function(t){var e,i=this;t.save(),this.coords.forEach((function(e){e.drawControl(t,i.angle)})),(null===(e=this.centerControlCoords)||void 0===e?void 0:e.length)&&this.centerControlCoords.forEach((function(e){e.drawControl(t,i.angle)})),t.restore()}},{key:"_drawBorders",value:function(){}},{key:"set",value:function(t,e){this._set(t,e)}},{key:"_set",value:function(t,e){this[t]=e}},{key:"strokeOrFill",value:function(t){this.stroke&&t.stroke(),this.fill&&t.fill()}},{key:"getCommonConfig",value:function(){return{cornerSize:this.cornerSize,cornerStyle:this.cornerStyle,cornerColor:this.cornerColor,cornerBorderColor:this.cornerBorderColor,cornerOpacity:this.cornerOpacity}}}]),t}(),I=function(){function t(e){r(this,t),s(this,"cornerSize",10),s(this,"cornerStyle","square"),s(this,"cornerBorderColor","#000"),s(this,"cornerColor",""),s(this,"cornerOpacity",1),s(this,"left",0),s(this,"top",0),s(this,"center",null),s(this,"cursor","move"),s(this,"isEditing",!1),s(this,"mousemoveHandler",(function(){return null})),s(this,"mousedownHandler",(function(){return null})),s(this,"mouseupHandler",(function(){return null})),this.setOptions(e)}return o(t,[{key:"setOptions",value:function(t){for(var e in t)this[e]=t[e]}},{key:"drawControl",value:function(t,e){var i=t.getTransform();t.save(),t.translate(this.left,this.top),t.lineWidth=1/i.a,t.globalAlpha=this.cornerOpacity,t.rotate(e),t.beginPath(),t.strokeStyle=this.cornerBorderColor,t.fillStyle=this.cornerColor,"circle"===this.cornerStyle?t.arc(0,0,this.cornerSize/2/i.a,0,2*Math.PI,!1):t.rect(-this.cornerSize/2/i.a,-this.cornerSize/2/i.a,this.cornerSize/i.a,this.cornerSize/i.a),t.closePath(),this.cornerBorderColor&&t.stroke(),this.cornerColor&&t.fill(),t.restore()}},{key:"isPointInControl",value:function(t,e){var i=t.x,r=t.y,n=e.a,o=this.left,s=this.top;return i>=o-this.cornerSize/2/n&&i<=o+this.cornerSize/2/n&&r>=s-this.cornerSize/2/n&&r<=s+this.cornerSize/2/n}},{key:"setAngle",value:function(t){var e=this.center,i=e.x,r=e.y,n=(this.left-i)*Math.cos(t)-(this.top-r)*Math.sin(t)+i,o=(this.left-i)*Math.sin(t)+(this.top-r)*Math.cos(t)+r;this.left=n,this.top=o}},{key:"getCoords",value:function(){return{x:this.left,y:this.top}}},{key:"set",value:function(t,e){this[t]=e}},{key:"updatePointPosition",value:function(){}}]),t}(),z=function(t){a(n,t);var e=u(n);function n(t){var i;return r(this,n),s(c(i=e.call(this,t)),"textX",void 0),s(c(i),"textY",void 0),i.type="rect",i}return o(n,[{key:"_render",value:function(t){t.save();var e=-this.width*this.scaleX/2,i=-this.height*this.scaleY/2,r=this.width*this.scaleX,n=this.height*this.scaleY;t.beginPath(),t.lineWidth=this.lineWidth/Math.abs(this.transformMatrix.a),t.strokeStyle=this.stroke,t.fillStyle=this.fill,t.rect(e,i,r,n),t.closePath(),this.strokeOrFill(t),t.restore()}},{key:"setCoords",value:function(t){var e=this,r=this.width*this.scaleX,n=this.height*this.scaleY,o=this.originX,s=this.originY,a=t.getTransform(),h={x:this.originX,y:this.originY},l=this.getCommonConfig();if("rect"===this.type){this.coords=[new I(i({left:o-r/2,top:s-n/2,target:this,base:"right-bottom",cursor:this.rotate?"pointer":"se-resize",mousemoveHandler:k},l)),new I(i({left:o,top:s-n/2,target:this,base:"center-bottom",cursor:this.rotate?"pointer":"n-resize",mousemoveHandler:C},l)),new I(i({left:o+r/2,top:s-n/2,target:this,base:"left-bottom",cursor:this.rotate?"pointer":"ne-resize",mousemoveHandler:k},l)),new I(i({left:o+r/2,top:s,target:this,base:"left-center",cursor:this.rotate?"pointer":"w-resize",mousemoveHandler:w},l)),new I(i({left:o+r/2,top:s+n/2,target:this,base:"left-top",cursor:this.rotate?"pointer":"se-resize",mousemoveHandler:k},l)),new I(i({left:o,top:s+n/2,target:this,base:"center-top",cursor:this.rotate?"pointer":"n-resize",mousemoveHandler:C},l)),new I(i({left:o-r/2,top:s+n/2,target:this,base:"right-top",cursor:this.rotate?"pointer":"ne-resize",mousemoveHandler:k},l)),new I(i({left:o-r/2,top:s,target:this,base:"right-center",cursor:this.rotate?"pointer":"w-resize",mousemoveHandler:w},l))];var c=this.coords.map((function(t){return t.getCoords()})),u=Math.min.apply(Math,v(c.map((function(t){return t.x})))),f=Math.min.apply(Math,v(c.map((function(t){return t.y}))));this.textX=u,this.textY=f,this.rotate&&this.coords.push(new I(i({left:u+Math.abs(r)/2,top:f-40/a.a,target:this,base:"center-center",cursor:"crosshair",mousemoveHandler:P},l)))}this.coords.forEach((function(t){var i,r,n,o=(i={x:t.left,y:t.top},r=h,n=e.angle,{x:(i.x-r.x)*Math.cos(n)-(i.y-r.y)*Math.sin(n)+r.x,y:(i.x-r.x)*Math.sin(n)+(i.y-r.y)*Math.cos(n)+r.y}),s=o.x,a=o.y;t.left=s,t.top=a})),this.points=[this.coords[0].getCoords(),this.coords[2].getCoords(),this.coords[4].getCoords(),this.coords[6].getCoords()]}}]),n}(X),E=function(t){a(n,t);var e=u(n);function n(t){var i;return r(this,n),s(c(i=e.call(this,t)),"centerControlPoints",[]),s(c(i),"needCenterControl",!0),s(c(i),"centerPointsStyle","square"),s(c(i),"centerPointsSize",10),s(c(i),"centerPointsStroke","#f00"),s(c(i),"centerPointsFill","#fff"),i.type="polygon",i.setOptions(t),i}return o(n,[{key:"_render",value:function(t){var e=this.transformMatrix;e.a,e.b,e.c,e.d,e.e,e.f,t.save(),t.beginPath(),t.strokeStyle=this.stroke||"#000",t.fillStyle=this.fill||"#000",this.points.forEach((function(e,i){t[i?"lineTo":"moveTo"](e.x,e.y)})),t.closePath(),this.strokeOrFill(t),t.restore(),this.drawArrow(t,this.points[0].x,this.points[0].y,(this.points[0].x+this.points[1].x)/2,(this.points[0].y+this.points[1].y)/2),this.needCenterControl&&this.renderCenterControl(t)}},{key:"drawArrow",value:function(t,e,i,r,n){t.save(),t.beginPath();var o=function(t,e,i,r){var n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:50,o=arguments.length>5?arguments[5]:void 0,s=Math.atan2(r-e,i-t);return[i-n*Math.cos(s+o*Math.PI/180),r-n*Math.sin(s+o*Math.PI/180),i-n*Math.cos(s-o*Math.PI/180),r-n*Math.sin(s-o*Math.PI/180)]},s=f(o(e,i,r,n,15,30),4),a=s[0],h=s[1],l=s[2],c=s[3],u=this.transformMatrix;u.a,u.b,u.c,u.d,u.e,u.f,t.moveTo(a,h),t.lineTo(r,n),t.lineTo(l,c),t.lineWidth=5/this.transformMatrix.a,t.strokeStyle=this.stroke,t.fillStyle="#000",t.globalAlpha=1,t.stroke(),t.closePath(),t.restore()}},{key:"setCoords",value:function(){var t=this;this.coords=this.points.map((function(e,r){return new I(i({left:e.x,top:e.y,target:t,cursor:"pointer",index:r,mousemoveHandler:O},t.getCommonConfig()))}))}},{key:"renderCenterControl",value:function(t){var e=this;this.centerControlPoints=this.points.map((function(t,i){return[t,e.points[(i+1)%e.points.length]]})).map((function(t){var e=f(t,2),i=e[0],r=e[1];return{x:(i.x+r.x)/2,y:(i.y+r.y)/2}})),this.centerControlCoords=this.centerControlPoints.map((function(t,i){return new I({left:t.x,top:t.y,target:e,cursor:"copy",index:i,cornerStyle:e.centerPointsStyle,cornerSize:e.centerPointsSize,cornerBorderColor:e.centerPointsStroke,cornerColor:e.centerPointsFill,mousedownHandler:T})}))}}]),n}(X),H=function(t){a(n,t);var e=u(n);function n(t){var i;return r(this,n),s(c(i=e.call(this,t)),"centerControlPoints",[]),i.type="line",i.setOptions(t),i}return o(n,[{key:"_render",value:function(t){var e=this.transformMatrix;e.a,e.b,e.c,e.d,e.e,e.f,t.save(),t.beginPath(),t.strokeStyle=this.stroke||"#000",t.fillStyle=this.fill||"#000",this.points.forEach((function(e,i){t[i?"lineTo":"moveTo"](e.x,e.y)})),t.stroke(),t.closePath(),t.restore(),this.renderCenterControl(t)}},{key:"setCoords",value:function(){var t=this;this.coords=this.points.map((function(e,r){return new I(i({left:e.x,top:e.y,target:t,cursor:"pointer",index:r,mousemoveHandler:O},t.getCommonConfig()))}))}},{key:"renderCenterControl",value:function(){var t=this;this.centerControlPoints=this.points.map((function(e,i){return[e,t.points[(i+1)%t.points.length]]})).map((function(t){var e=f(t,2),i=e[0],r=e[1];return{x:(i.x+r.x)/2,y:(i.y+r.y)/2}})),this.centerControlPoints=this.centerControlPoints.slice(0,this.centerControlPoints.length-1),this.centerControlCoords=this.centerControlPoints.map((function(e,i){return new I({left:e.x,top:e.y,target:t,cursor:"copy",index:i,mousedownHandler:T})}))}},{key:"isPointInPath",value:function(t){for(var e=this,i=this.points.map((function(t,i){return[t,e.points[(i+1)%e.points.length]]})),r=0,n=i.length;r<n;r++){var o=i[r][0],s=i[r][1],a=Math.sqrt(Math.pow(t.x-o.x,2)+Math.pow(t.y-o.y,2));if(Math.sqrt(Math.pow(t.x-s.x,2)+Math.pow(t.y-s.y,2))+a-Math.sqrt(Math.pow(s.x-o.x,2)+Math.pow(s.y-o.y,2))<.5/this.transformMatrix.a)return!0}}}]),n}(X),R=function(t){a(i,t);var e=u(i);function i(t){var n;return r(this,i),(n=e.call(this,t)).type="point",n}return o(i,[{key:"_render",value:function(t){t.save(),t.beginPath(),t.arc(0,0,this.radius/this.transformMatrix.a,0,2*Math.PI),t.strokeStyle=this.stroke,t.fillStyle=this.fill,t.closePath(),this.strokeOrFill(t),t.restore()}},{key:"setCoords",value:function(t){this.coords=[new I({left:this.left,top:this.top,target:this,cursor:"pointer",mousemoveHandler:j})]}},{key:"isPointInPath",value:function(t){var e=this.radius/this.transformMatrix.a;if(t.x<this.left+e&&t.y<this.top+e&&t.x>this.left-e&&t.y>this.top-e)return!0}}]),i}(X),L=function(t){a(i,t);var e=u(i);function i(t){var n;r(this,i),n=e.call(this,t);var o=t.points;return n.width=Math.abs(o[0].x-o[1].x),n.height=Math.abs(o[0].y-o[1].y),n.type="arrow",n}return o(i,[{key:"_render",value:function(t){var e=t.getTransform();t.save(),t.beginPath();var i=this.points[0],r=i.x,n=i.y,o=this.points[1],s=o.x,a=o.y,h=function(t,e,i,r){var n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:50,o=arguments.length>5?arguments[5]:void 0,s=Math.atan2(r-e,i-t);return[i-n*Math.cos(s+o*Math.PI/180),r-n*Math.sin(s+o*Math.PI/180),i-n*Math.cos(s-o*Math.PI/180),r-n*Math.sin(s-o*Math.PI/180)]}(r,n,s,a,20,30),l=f(h,4),c=l[0],u=l[1],v=l[2],d=l[3];t.moveTo(r,n),t.lineTo(s,a),t.moveTo(c,u),t.lineTo(s,a),t.lineTo(v,d),t.lineWidth=this.lineWidth/e.a,t.strokeStyle=this.stroke,t.globalAlpha=this.opacity,t.stroke(),t.closePath(),t.restore()}},{key:"setCoords",value:function(t){var e,i,r=this.width*this.scaleX,n=this.height*this.scaleY,o={x:e=this.points[0].x<this.points[1].x?this.points[0].x+this.width/2:this.points[1].x+this.width/2,y:i=this.points[0].y<this.points[1].y?this.points[0].y+this.height/2:this.points[1].y+this.height/2};this.coords=[new I({x:e-r/2,y:i-n/2,center:o,target:this,base:"right-bottom",cursor:"not-allowed"}),new I({x:e,y:i-n/2,center:o,target:this,base:"center-bottom",cursor:"not-allowed"}),new I({x:e+r/2,y:i-n/2,center:o,target:this,base:"left-bottom",cursor:"not-allowed"}),new I({x:e+r/2,y:i,center:o,target:this,base:"left-center",cursor:"not-allowed"}),new I({x:e+r/2,y:i+n/2,center:o,target:this,base:"left-top",cursor:"not-allowed"}),new I({x:e,y:i+n/2,center:o,target:this,base:"center-top",cursor:"not-allowed"}),new I({x:e-r/2,y:i+n/2,center:o,target:this,base:"right-top",cursor:"not-allowed"}),new I({x:e-r/2,y:i,center:o,target:this,base:"right-center",cursor:"not-allowed"})],this.isActive&&(t.beginPath(),this.coords.forEach((function(e,i){t[i?"lineTo":"moveTo"](e.x,e.y)})),t.closePath(),t.stroke())}}]),i}(X),W=function(t){a(i,t);var e=u(i);function i(t){var n;return r(this,i),s(c(n=e.call(this,t)),"xScales",[]),s(c(n),"yScales",[]),s(c(n),"coords",[]),s(c(n),"fontSize",12),n.type="Ruler",n.fontSize=t.fontSize,n}return o(i,[{key:"_render",value:function(t){var e,i,r,n,o;t.strokeStyle=this.stroke,t.fillStyle=this.stroke,this.transformMatrix.a>5?(i=t.canvas.width,r=t.canvas.height,n=1,o=10):this.transformMatrix.a<.6?(i=t.canvas.width/50,r=t.canvas.height/50,n=50,o=100):(i=t.canvas.width/5,r=t.canvas.height/5,n=5,o=50),t.save(),t.setTransform(this.transformMatrix.a,0,0,this.transformMatrix.a,this.transformMatrix.e,0),e=this.fontSize/this.transformMatrix.a,t.font="bold ".concat(e,"px Alibaba_PuHuiTi_Regular");for(var s=0;s<=i;s++){if(t.beginPath(),t.moveTo(s*n,0),s*n%o==0){t.lineTo(s*n,15/this.transformMatrix.a);var a=t.measureText(s*n).width;t.fillText(s*n,s*n-a/2,30/this.transformMatrix.a)}else t.lineTo(s*n,5/this.transformMatrix.a);t.stroke(),t.closePath()}t.restore(),t.save(),t.setTransform(this.transformMatrix.a,0,0,this.transformMatrix.a,0,this.transformMatrix.f),e=this.fontSize/this.transformMatrix.a,t.font="bold ".concat(e,"px Alibaba_PuHuiTi_Regular");for(var h=0;h<=r;h++){if(t.beginPath(),t.moveTo(0,h*n),h*n%o==0)t.lineTo(15/this.transformMatrix.a,h*n),t.measureText(h*n).width,t.fillText(h*n,20/this.transformMatrix.a,h*n+5/this.transformMatrix.a);else t.lineTo(5/this.transformMatrix.a,h*n);t.stroke(),t.closePath()}t.restore()}}]),i}(X),B=function(t){a(i,t);var e=u(i);function i(t){var n;return r(this,i),s(c(n=e.call(this,t)),"fillText",!0),s(c(n),"relationShipId",""),s(c(n),"fontSize",20),s(c(n),"parent",null),n.type="Text",n.fillText=t.fillText,n.fontSize=t.fontSize,n}return o(i,[{key:"_render",value:function(t){t.save(),t.translate(this.parent.textX,this.parent.textY);var e=this.fontSize/this.transformMatrix.a;t.font="bold ".concat(e,"px Alibaba_PuHuiTi_Regular"),t.beginPath(),t.fillStyle=this.fill,this.fillText&&t.fillText(this.text,0,-5/this.transformMatrix.a),t.closePath(),t.restore()}},{key:"isPointInPath",value:function(){}}]),i}(X),D=function(t){a(i,t);var e=u(i);function i(t){var n;return r(this,i),(n=e.call(this,t)).type="crosshairline",n}return o(i,[{key:"_render",value:function(t){var e=this.points.x*this.transformMatrix.a+this.transformMatrix.e,i=this.points.y*this.transformMatrix.a+this.transformMatrix.f;t.save(),t.setTransform(1,0,0,1,0,0),t.lineWidth=1,t.strokeStyle=this.stroke,t.beginPath(),t.moveTo(e,0),t.lineTo(e,t.canvas.height),t.stroke(),t.closePath(),t.restore(),t.save(),t.lineWidth=1,t.setTransform(1,0,0,1,0,0),t.strokeStyle=this.stroke,t.beginPath(),t.moveTo(0,i),t.lineTo(t.canvas.width,i),t.stroke(),t.closePath(),t.restore()}}]),i}(X);t.Arrow=L,t.Canvas=Y,t.CrosshairLine=D,t.DrawObject=X,t.Line=H,t.Point=R,t.Polygon=E,t.Rect=z,t.Ruler=W,t.Text=B}));
